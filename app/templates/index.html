{% extends 'base.html' %}
{% block title %}–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ {% endblock %}
{% block content %}

    <div class="page-wrapper">
        <div class="contols-btns">
            <div class="table-info col-6">
                <label class="label-style" style="background-color: #dbe1ff; color: #616161;">–í—Å–µ–≥–æ: {{project_count}} </label>
                <label class="label-style" style="background-color: #caffe2; color: #336d00;">–í —Ä–∞–±–æ—Ç–µ: {{ status_stats['–í —Ä–∞–±–æ—Ç–µ'] }}</label>
                <label class="label-style" style="background-color: #fffbd4; color: #634a00;">–¢–µ—Ö. –ø—Ä–æ–¥–ª–µ–Ω–∏–µ: {{ status_stats['–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ'] }}</label>
                <label class="label-style" style="background-color: #ffa0a0; color: #770000;">–ó–∞–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: {{ status_stats['–ó–∞–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'] }}</label>
            </div>
            <div class="table-actions col-6">
                <div class="lvl">
                    <a href="{{url_for('project_new.create_project')}}" class="btn btn-table-info btn-table-info-add "><img src="/static/img/add.png" alt="+" style="width: 30px;">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</a>
                </div>
                <div class="lvl">
                    <div class="search-container">
                        <img src="/static/img/search.png" alt="–ü–æ–∏—Å–∫" class="search-icon">
                        <input type="text" id="search-input-index" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø—Ä–æ–µ–∫—Ç—É...">
                        <span class="clear-icon" id="clear-search-index">&times;</span>
                    </div>
                    <a class="btn btn-table-info btn-hover" id="export-btn" data-bs-toggle="modal" data-bs-target="#filterModal"><img src="/static/img/export.png" alt="+" style="width: 30px;">–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è/–≠–∫—Å–ø–æ—Ä—Ç</a>
                </div>
            </div>
        </div>
        <div class="content">
                    <div class="table-block-parametres">
                        <table class="custom-table" id="custom-table-index">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="highlight-toggle-in-table" title="–ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫">
                                    </th>
                                    <th>–ù–û–ú–ï–† –ü–†–û–ï–ö–¢–ê</th>
                                    <th>–ù–ê–ó–í–ê–ù–ò–ï –ü–†–û–ï–ö–¢–ê</th>
                                    <th>–¢–ò–ü</th>
                                    <th>–ö–£–†–ê–¢–û–†</th>
                                    <th>P.OWNER (–°–ü–ò–ö–ï–†)</th>
                                    <th>DEADLINE</th>
                                    <th>–°–¢–ê–¢–£–°</th>
                                    <th>–î–ï–ô–°–¢–í–ò–Ø</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for project in projects %}
                                    <tr class="status-{{project.status|lower|replace(' ', '-')|replace('—ë', '–µ')}}">
                                        <td></td>
                                        <td>{{ project.project_number }}</td>
                                        <td>{{ project.title }}</td>
                                        <td>{{ project.project_type }}</td>
                                        <td>{{ project.curator }}</td>
                                        <td>{{ project.product_owner }}</td>
                                        <td>{{ project.deadline.strftime('%Y-%m-%d') if project.deadline else '-' }}</td>
                                        <td>{{ project.status }}</td>
                                        <td>
                                            <div class="dropdown" style="position: unset;">
                                                <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                    ‚ãØ
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <a class="dropdown-item" href="{{ url_for('project_new.view_project', project_id=project.id) }}">
                                                            üîç –ü—Ä–æ—Å–º–æ—Ç—Ä
                                                        </a>
                                                    </li>

                                                    {% if (project.creator == current_user.id and project.status != '–ó–∞–≤–µ—Ä—à–µ–Ω') or current_user.status == 1 %}
                                                    <li>
                                                        <a class="dropdown-item" href="{{ url_for('project_new.edit_project', project_id=project.id) }}">
                                                            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                                        </a>
                                                    </li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
        </div>
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
        <div class="modal fade" id="filterModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
            <form method="get" action="{{ url_for('project_new.index') }}">
                <div class="modal-header">
                <h5 class="modal-title">–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                <div class="mb-3">
                    <label>–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞</label>
                    <select name="status" class="form-select">
                    <option value="">–õ—é–±–æ–π</option>
                    <option value="–í —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
                    <option value="–ó–∞–≤–µ—Ä—à–µ–Ω">–ó–∞–≤–µ—Ä—à–µ–Ω</option>
                    <option value="–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ</option>
                    <option value="–ó–∞–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è">–ó–∞–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label>–ö—É—Ä–∞—Ç–æ—Ä</label>
                    <input type="text" name="curator" class="form-control">
                </div>
                </div>
                <div class="modal-footer">
                <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
                <a id="exportBtn" class="btn btn-success" href="#">–≠–∫—Å–ø–æ—Ä—Ç</a>
                </div>
            </form>
            </div>
        </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>

    document.addEventListener('DOMContentLoaded', function () {

        const table = document.getElementById('custom-table-index')

        if (!table) {
            return
        }  
        
        const toggle = document.getElementById('highlight-toggle-in-table');
        const storedPref = localStorage.getItem('highlightByType');

        if (storedPref === 'true') {
            table.classList.add('highlight-by-type');
            toggle.checked = true;
        } else {
            table.classList.remove('highlight-by-type');
            toggle.checked = false
        }

        toggle.addEventListener('change', function () {
            const enabled = toggle.checked;
            if (enabled) {
                table.classList.add('highlight-by-type');
                localStorage.setItem('highlightByType', 'true');
            } else {
                table.classList.remove('highlight-by-type');
                localStorage.setItem('highlightByType', 'false');         
            }
        });

        const exportBtn = document.getElementById('exportBtn');
        const form = document.querySelector('#filterModal form');

        // –°–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        function buildExportUrl() {
            const formData = new FormData(form);
            const params = new URLSearchParams(formData).toString();
            return "{{ url_for('act.export_filtered') }}" + '?' + params;
        }

        exportBtn.addEventListener('click', function (e) {
            e.preventDefault();  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ –ø—É—Å—Ç–æ–π —Å—Å—ã–ª–∫–µ
            const url = buildExportUrl();
            window.location.href = url;  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º
        });

        // –ú–æ–∂–Ω–æ –∑–∞—Ä–∞–Ω–µ–µ –æ–±–Ω–æ–≤–ª—è—Ç—å href –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
        form.addEventListener('input', () => {
            exportBtn.href = buildExportUrl();
        });
});
</script>
{% endblock %}